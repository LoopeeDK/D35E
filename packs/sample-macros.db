{"_id":"mNwCjMkfhX8jcfPL","name":"Award XP","type":"script","author":"VIfT2pClvTXfstmc","img":"icons/svg/book.svg","scope":"global","command":"//This Macro distributed EXP awarted by monsters that are selected by Target Tools to party members that are places on map. (Party members - Characters that have Party Member checked)\n//Determine Actors grab their info for later\n\nlet users = game.users.entries\nlet avgLevel = 0\nlet actorCount = 0\nconst tokens = [...canvas.tokens.placeables];\nvar actorArray = new Array\n//For each token on the Cavnas push ONLY party members to Array\ntokens.forEach(token => {\n\n    if(token?.actor?.data?.data?.isPartyMember){\n        actorArray.push({id:token.actor.id,name:token.actor.data.name,level:token.actor.data.data.details.level.value,image:token.actor.data.img,classes:token.actor.data.items.filter(item => item.type == \"class\").filter(item => item.data.classType == \"base\")})\n//count the ammount of players (for the exp split later) and the Average party level\nactorCount ++\navgLevel +=token.actor.data.data.details.level.value}\n\n});\nconsole.log(actorArray)\n//Determine EXP\n//Targeted defeated Creatures\nlet targets = game.user.targets\nlet expTotal = 0\nfor (let target of targets) {\nlet partyLevelReal = avgLevel/actorCount\npartyLevelReal = Math.max(partyLevelReal,3)\nlet CR = target.actor.data.data.details.cr\nif(CR == undefined){CR = target.actor.data.data.details.level.value}\n\n\nlet partyLevel = partyLevelReal-CR\n\npartyLevel = partyLevelReal-CR\n\n\n\n//if Party is above CR\nif(partyLevel>0){\n\nlet i = partyLevelReal-CR\nlet a = 1\nlet exp = 300*(CR)\nwhile(i>0){\nexp = exp-((100/(Math.pow(2,Math.ceil((a-1)/2))))*CR)\n\ni--\na++\n}\n\n\nexp = Math.ceil(exp*partyLevelReal/CR)\nexp = Math.min(exp,300*CR)\n\n\nexpTotal = expTotal+exp\npartyLevelReal++\n}else{\n//if Party is at or below the CR\n\nlet i = partyLevelReal-CR\nlet a = 1\nlet exp = 300*(CR) //Base EXP\nwhile(i<0){\nexp = exp+(Math.pow(2,Math.ceil((a/2)))*75)*CR\n\ni++\na++\n}\n\n//Converted Exp\nexp = Math.ceil(exp*partyLevelReal/CR);\n\n//All of the EXP from all of the Creatures combined\nexpTotal = expTotal+exp\n\n}\n}\n\n\n\n//Determine the Monsters grab their info for later\n\nlet monsterList = new Array\nlet monsterSet = new Set\nlet monsterSet2 = new Set\nvar i;\ntargets = game.user.targets;\nfor (let target of targets) {\nmonsterList.push({id:target.actor.id,name:target.actor.name,cr:target.actor.data.data.details.cr,image:target.actor.data.img})\nif(!monsterSet2.has(target.actor.id)){\n\nmonsterSet2.add(target.actor.id)\nlet CR = target.actor.data.data.details.cr\nif(CR == undefined){monsterSet.add({id:target.actor.id,name:target.actor.name,cr:target.actor.data.data.details.level.value,image:target.actor.data.img})}\nelse\n{monsterSet.add({id:target.actor.id,name:target.actor.name,cr:target.actor.data.data.details.cr,image:target.actor.data.img})}\n}\n\n}\n\n\n\n\n\n//Count Duplicates for the Display\n    let flattened = monsterList.reduce((a, b) => a.concat(b), []); //flatten it out so next command can count\n\n\n   \n    let counts = flattened.reduce(                                       //count each attack in arrays to compare to the number of actors selected later\n        (map, { id }) => map.set(id, (map.get(id) || 0) + 1), new Map()\n    );\n\n\n//shove it all together Monsters name and CR + How many we found\nlet countArray = new Array\nfor (let [key, value] of counts) {\n\nfor(i of monsterSet){\nif(i.id===key){\ncountArray.push({id:i.id,count:value,name:i.name,cr:i.cr,image:i.image})\nconsole.log(countArray)\n\n}\n}\n}\n//Grab the data of what to show the Dialog box\nvar expEach = Math.floor(expTotal/actorCount)\n\nvar data = {targets:countArray,actors:actorArray,exp:expTotal,count:expEach} \n\n\n//HTML template\n    const contentRaw = `\n      <form>\n      <script type=\"text/javascript\">\n      function giveExp(exp,actorId){\nlet tokenExp = game.actors.get(actorId)\n\ntokenExp.update({'data.details.xp.value':Number(tokenExp._data.data.details.xp.value) + Number(exp)})\n\n};\n      </script>\n<style>\n.flex-container {\n    display: flex;\n    flex-flow: nowrap;\n    height:32px;\n  }\n \n  .flex-container > div {\n    width: 144px;\n    margin: 2px;\n    text-align: center;\n    line-height: 32px;\n    font-size: 14px;\n    text-overflow: ellipsis;\n    height:32px;\n  }\n  .flex-container > div.double-wide {\n    width: 288px;\n    margin: 4px;\n    text-align: center;\n    line-height: 32px;\n    font-size: 14px;\n  }\n</style>\n    <label>Defeated Creatures</label>\n<div></div>\n\n    <div class=\"flex-container\">\n       <p>(only targeted monsters will show up)</p>\n</div>\n    <fieldset>\n    <div>\n    <div>\n\n    {{#each targets}}\n    <div class=\"flex-container\">\n\n    <img src=\"{{image}}\" width=\"32\" height=\"32\">\n    \n    <div><em>x{{count}}</em></div>\n    <div class=\"double-wide\"> {{name}}</div>\n    <div></div>\n    <div> CR:{{cr}}</div>\n    \n    \n    </div>\n    {{/each}}\n\n    </div>\n    </div>\n\n    </fieldset>\n<label>Party Characters</label>\n    <fieldset>\n           {{#each actors}}\n           <div class=\"flex-container\">\n           <img src=\"{{image}}\" width=\"32\" height=\"32\">\n           <div class=\"double-wide\"><em> {{name}}</em></div>\n           <div><em> Level:{{level}}</em></div>         \n           <div><button type=\"button\" id= {{id}} onclick=\"this.disabled=true;giveExp({{../count}},'{{id}}')\">Award Exp</button></div>\n           </div>\n           {{/each}}\n\n    </fieldset>\n<p>total exp: {{exp}}<p>\n<p>exp each: {{count}}</p>\n\n      </form>\n    `\n    //process it\n    const template = Handlebars.compile(contentRaw);//make template ready for the data we prepped\n    const content = template(data); //The Template proccessed, with all the data ready for Dialog box\n    console.log(content)\n    let found = monsterList.filter(({ name }) => counts.get(name) === monsterList.length); //Compare the number of Duplicates of each attack to the Number of Actors selected (to make sure they all have the attack)\n//Dialog box stuff\nlet d = new Dialog({\n\n    title: \"EXP Calculation\",\n    content: content, //Where the Proccessed template ends up\n    buttons: {\n\n     two: {\n      icon: '<i class=\"fas fa-times\"></i>',\n      label: \"Close\",\n      callback: () => console.log(\"Chose Two\")\n     }\n    },\n    default: \"two\",\n    render: html => console.log(\"Register interactivity in the rendered dialog\"),\n    close: html => console.log(\"This always is logged no matter which option is chosen\")\n    \n   },({width:800}));\n\n   d.render(true);","folder":null,"sort":0,"permission":{"default":0,"VIfT2pClvTXfstmc":3},"flags":{"core":{"sourceId":"Macro.TkWUk7sH2Ggsx5eP"}}}
{"_id":"ntsVqpwD52tRF1nN","name":"Mass Token Attack","permission":{"default":0,"VIfT2pClvTXfstmc":3},"type":"script","flags":{"core":{"sourceId":"Macro.NUK2KVTOFkSEcIhg"}},"scope":"global","command":"//If no tokens are selected this Macro wont work\nif (canvas.tokens.controlled == 0) { ui.notifications.error(\"Please Select one or more Actors\") } else {\n    //Declare Variables\n    var attackArrayCombined = new Array\n    let actors = canvas.tokens.controlled.map(token => {\n        return token.actor\n    });\n    //Do this for each actor selected\n    for (let actor of actors) {\n        //more Variables to be declared (But inside this loop)\n        let myArray = actor.data.items\n        var attackSet = new Set\n        const attackArray = myArray\n            .filter((item) => item.type === 'attack') // filter to only attacks\n            .map((item) => { //map over each item and if it's a duplicate add a blank else? add it to the Array and set \n                const name = `${item.name}`;\n                if (attackSet.has(name)) {\n                    return { name: '' }\n                } else {\n                    attackSet.add(name)\n                    return { name }\n                }\n            }\n            );\n\n        const attackArrayNew = attackArray.filter((item) => item.name !== '') //filter out blanks\n\n        attackArrayCombined.push(attackArrayNew)//Combine the Arrays that were generated for each actor into one place\n    }\n    let flattened = attackArrayCombined.reduce((a, b) => a.concat(b), []); //flatten it out so next command can count\n\n    let counts = flattened.reduce(                                       //count each attack in arrays to compare to the number of actors selected later\n        (map, { name }) => map.set(name, (map.get(name) || 0) + 1), new Map()\n    );\n    let found = attackArrayCombined[0].filter(({ name }) => counts.get(name) === attackArrayCombined.length); //Compare the number of Duplicates of each attack to the Number of Actors selected (to make sure they all have the attack)\n    if (found == 0) {\n        ui.notifications.error(\"Either Selected Actor has no Attacks or Selected Actors do not have common attacks, Cannot Batch Roll\")//if actors have no attacks in common then give an error and stop\n    } else { //if they do...\n        var data = { attacks: found } //so it makes sense to handlebars\n        const contentRaw = `\n      <form>\n    <div class=\"form-group\" >\n    <label id='attackDataHere'>Available Attacks:</label>   \n    <select id=\"choices\" name=\"choices\">\n           {{#each attacks}}<option value=\"{{name}}\">{{name}}</option>{{/each}}\n          </select>\n        </div>\n  <em>Select attack that you want to roll for selected tokens. by default will roll first valid attack on respective character sheet.</em>\n      </form>\n    `//HTML template so that we can have a drop down\n        const template = Handlebars.compile(contentRaw);//give the html template to handlebars\n        const content = template(data); //use our attack data from before to insert into template\n        let selectedOption; //declaring another variable :D\n        //Make a dialog and make it do things and stuff\n        let dialog = new Dialog({\n            title: \"Attack Selection\",\n            content: content, //this is where that HTML ends up\n            //what do you want the buttons to do?\n            buttons: {\n                yes: {\n                    icon: '<i class=\"fas fa-dice\"></i>',\n                    label: \"Attack\",\n                    callback: () => {\n                        selectedOption = document.getElementById('choices').value;\n                    },\n                },\n                no: {\n                    icon: '<i class=\"fas fa-times\"></i>',\n                    label: \"Cancel\",\n                }\n            },\n            default: \"yes\", //Default point to yes\n            close: () => {\n                if (selectedOption) {\n                    switch (selectedOption) {\n                        default: //the default option for the Dialog, it was easy to put the code here so i did\n                            let actors = canvas.tokens.controlled.map(token => { //gotta declare the actors again\n                                return token.actor\n                            })\n                            for (let actor of actors) { //another for loop for each of the actors so they each do their attack\n                                var itemFound = actor.items.find(item => item.name === `${selectedOption}` && item.type === \"attack\") // ${selectedOption} is the name of the attack(sometimes shared with weapons) \n                                //so we don't want any weapons from your character sheet only the attacks they produce\n                                let item = itemFound.useAttack({ skipDialog: true }) // Skip dialog will use the attack without making a bunch of other pop ups \n                                item\n                            }\n                    }\n                }\n            }\n        }\n        );\n        dialog.render(true); //RENDER!!!!\n    }\n}","author":"VIfT2pClvTXfstmc","img":"icons/svg/sword.svg","actorIds":[]}
